!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("prop-types"),require("react-router-dom")):"function"==typeof define&&define.amd?define(["exports","react","prop-types","react-router-dom"],t):t(e.CacheRoute={},e.React,e.PropTypes,e.reactRouterDom)}(this,function(e,_,t,s){"use strict";var w="default"in _?_.default:_;t=t&&t.hasOwnProperty("default")?t.default:t;var o=function(e){return void 0===e},u=function(e){return null===e},i=function(e){return"function"==typeof e},l=function(e){return"string"==typeof e},n=function(e){return!(o(e)||u(e))},r=function(e){return e instanceof Array},p=function(e){return"number"==typeof e&&!((t=e)!=t);var t},h=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2];try{p(t)&&(t=String(t));var r=(l(t)?t.split("."):t).reduce(function(e,t){return e[t]},e);return o(r)?n:r}catch(e){return n}},g=function(e){for(var t=arguments.length,n=Array(2<t?t-2:0),r=2;r<t;r++)n[r-2]=arguments[r];var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];o=l(o)?o.split("."):o;var c=h(e,o),a=h(e,o.slice(0,-1));return i(c)?c.call.apply(c,[a].concat(n)):c},m=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){return o(e)?g(t):g(e)},void 0)},c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},d=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),y=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},v=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},O=function(e,t){var n={};for(var r in e)0<=t.indexOf(r)||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},b=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},C=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,c=e}finally{try{!r&&i.return&&i.return()}finally{if(o)throw c}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},a=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},E="undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:Function("return this")(),j="object"===("undefined"==typeof global?"undefined":c(global))&&global&&global.Math===Math&&global.Array===Array?global:E,R=h(j,"document.body"),S=h(j,"document.scrollingElement",h(j,"document.documentElement",{}));function T(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return!!n(e)&&(e.scrollWidth>e.clientWidth||e.scrollHeight>e.clientHeight)}function k(e){return i(h(j,"document.getElementById"))?[].concat(a(m(g(e,"querySelectorAll","*"),[])),[e]).filter(T):[]}function K(e){var t=[].concat(a(new Set([].concat(a(function n(e){return e.reduce(function(e,t){return[].concat(a(e),a(r(t)?n(t):[t]))},[])}((r(e)?e:[e]).map(k))),a([S,R].filter(T)))))).map(function(e){return[e,{x:e.scrollLeft,y:e.scrollTop}]});return function(){t.forEach(function(e){var t=C(e,2),n=t[0],r=t[1],o=r.x,c=r.y;n.scrollLeft=o,n.scrollTop=c})}}var A={},N=function(){return Object.entries(A).filter(function(e){var t=C(e,2)[1];return t instanceof B?t.state.cached:Object.values(t).some(function(e){return e.state.cached})})},x=function(){return P({},A)},M=function(e,t){A[e]=t},L=function(e){delete A[e]},U=function(e){return g(e,"reset")},D=function(e){var t=h(A,[e]);t&&(t instanceof B?U(t):Object.values(t).forEach(U))},q=n(w.forwardRef),F="__isComputedUnmatch",H=function(e){return n(e)&&!0!==h(e,F)},W=function(e,t){var n=e.match,r=e.when,o=void 0===r?"forward":r;if(H(n)||(n=null),!t.cached&&n)return{cached:!0,matched:!0};if(t.matched&&!n){var c=h(e,"history.action"),a=!1;if(i(o))a=!o(e);else switch(o){case"always":break;case"back":["PUSH","REPLACE"].includes(c)&&(a=!0);break;case"forward":default:"POP"===c&&(a=!0)}if(a)return{cached:!1,matched:!1}}return{matched:!!n}},B=function(e){function l(e){var t;f(this,l);for(var n=arguments.length,r=Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];var a=b(this,(t=l.__proto__||Object.getPrototypeOf(l)).call.apply(t,[this,e].concat(r)));if(a.cacheLifecycles={__listener:{},didCache:function(e){a.cacheLifecycles.__listener.didCache=e},didRecover:function(e){a.cacheLifecycles.__listener.didRecover=e}},a.componentWillReceiveProps=q?void 0:function(e){var t=W(e,a.state);a.setState(t)},a.injectDOM=function(){try{g(a.__parentNode,"insertBefore",a.wrapper,a.__placeholderNode),g(a.__parentNode,"removeChild",a.__placeholderNode)}catch(e){}},a.ejectDOM=function(){try{var e=h(a.wrapper,"parentNode");a.__parentNode=e,g(a.__parentNode,"insertBefore",a.__placeholderNode,a.wrapper),g(a.__parentNode,"removeChild",a.wrapper)}catch(e){}},a.clearCache=function(){var e=a.props,t=e.cacheKey,n=e.unmount;if(h(t,"multiple")){var r=t.cacheKey,o=t.pathname,c=P({},x()[r]);delete c[o],0===Object.keys(c).length?L(r):M(r,c)}else L(t);n&&a.injectDOM()},a.reset=function(){delete a.__revertScrollPos,a.setState({cached:!1})},a.__cacheCreateTime=Date.now(),a.__cacheUpdateTime=a.__cacheCreateTime,e.cacheKey)if(h(e.cacheKey,"multiple")){var c=e.cacheKey,i=c.cacheKey,u=c.pathname;M(i,P({},x()[i],y({},u,a)))}else M(e.cacheKey,a);return"undefined"!=typeof document&&(a.__placeholderNode=document.createComment(" Route cached "+(e.cacheKey?'with cacheKey: "'+h(e.cacheKey,"cacheKey",e.cacheKey)+'" ':""))),a.state=W(e,{cached:!1,matched:!1}),a}return v(l,e),d(l,[{key:"componentDidUpdate",value:function(e,t){if(t.cached&&this.state.cached)return!0===t.matched&&!1===this.state.matched?(this.props.unmount&&this.ejectDOM(),this.__cacheUpdateTime=Date.now(),g(this,"cacheLifecycles.__listener.didCache")):!1===t.matched&&!0===this.state.matched?(this.props.saveScrollPosition&&g(this.__revertScrollPos),this.__cacheUpdateTime=Date.now(),g(this,"cacheLifecycles.__listener.didRecover")):void 0}},{key:"shouldComponentUpdate",value:function(e,t){var n=!1===this.state.matched&&!0===t.matched,r=!0===this.state.cached&&!1===t.cached,o=this.state.matched||t.matched||this.state.cached!==t.cached;return o&&((this.props.unmount&&r||n)&&this.injectDOM(),r||n||!this.props.saveScrollPosition||(this.__revertScrollPos=K(this.props.unmount?this.wrapper:void 0)),t.cached),o}},{key:"componentWillUnmount",value:function(){this.clearCache()}},{key:"render",value:function(){var t=this,e=this.state,n=e.matched,r=e.cached,o=this.props,c=o.className,a=void 0===c?"":c,i=o.behavior,u=o.children,l=m(g(i,void 0,!n),{}),h=l.className,s=void 0===h?"":h,p=O(l,["className"]),f=g(a+" "+s,"trim"),d=""!==f;return r?w.createElement("div",P({className:d?f:void 0},p,{ref:function(e){t.wrapper=e}}),g(u,void 0,this.cacheLifecycles)):null}}]),l}(_.Component);B.propsTypes={history:t.object.isRequired,match:t.object.isRequired,children:t.func.isRequired,className:t.string,when:t.oneOfType([t.func,t.oneOf(["forward","back","always"])]),behavior:t.func,unmount:t.bool,saveScrollPosition:t.bool},B.defaultProps={when:"forward",unmount:!1,saveScrollPosition:!1,behavior:function(e){return e?{style:{display:"none"}}:void 0}},B.getDerivedStateFromProps=q?W:void 0;var V=function(e){function a(){var e,t,n;f(this,a);for(var r=arguments.length,o=Array(r),c=0;c<r;c++)o[c]=arguments[c];return(t=n=b(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(o)))).render=function(){return g(n.props,"children")},n.shouldComponentUpdate=function(e){return e.when},b(n,t)}return v(a,e),a}(_.Component);V.propsTypes={when:t.bool.isRequired};var I=n(_.Fragment),X=function(e){function c(e){f(this,c);var a=b(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,e));z.call(a);var i=e.history,t=e.multiple,u=e.path,l=e.when,n=e.cacheKeyHook;if(a.history=i,t&&i){var r=n?n(u,P({},a.props,{history:{action:action,location:location}})):u,h=function(t){var e=a.props,n=e.component,r=e.render,o=e.children;return w.createElement(B,t,function(e){return w.createElement(V,{when:H(t.match)},function(){return Object.assign(t,{cacheLifecycles:e}),n?w.createElement(n,t):g(r||o,void 0,t)})})};a.cache[r]=[{updateTime:Date.now(),render:h}],a.prevPathname=i.location.pathname,a.nextPathname=a.prevPathname;var o=i.listen(function(e,t){console.log("location pathname",t,e.pathname,window.location.pathname,i.location.pathname),a.prevPathname=a.nextPathname,a.nextPathname=e.pathname;var n=a.props.cacheKeyHook,r=a.shouldCache(t,l,P({},a.props,{history:{action:t,location:e}}));if(a.nextPathname===u){if(r||"REPLACE"===t){var o=n?n(a.nextPathname,P({},a.props,{history:{action:t,location:e}})):a.nextPathname;"/"===u&&(a.cache[o].forEach(function(e){D(o+"__"+e.updateTime)}),a.cache[o]=[]),a.cache[o]=[{updateTime:Date.now(),render:h}].concat(a.cache[o]||[]),"/"===u&&a.forceUpdate()}}else if(a.prevPathname===u&&(!r||"REPLACE"===t)){var c=n?n(a.prevPathname,P({},a.props,{history:{action:t,location:e}})):a.prevPathname;a.cache[c]&&a.cache[c].shift()}switch(t){case"PUSH":console.log("hugo history push");break;case"POP":console.log("hugo history pop");break;case"REPLACE":console.log("hugo history replace");break;default:console.log("hugo history action: "+t)}});a.disposers.push(o)}return a}return v(c,e),d(c,[{key:"componentWillUnmount",value:function(){this.disposers.forEach(function(e){return e&&e()})}},{key:"render",value:function(){var e,d=this,t=this.props,n=t.children,r=t.render,o=t.component,c=t.className,a=t.when,i=t.behavior,m=t.cacheKey,y=t.cacheKeyHook,u=t.unmount,v=t.saveScrollPosition,l=t.computedMatchForCacheRoute,b=t.multiple,h=O(t,["children","render","component","className","when","behavior","cacheKey","cacheKeyHook","unmount","saveScrollPosition","computedMatchForCacheRoute","multiple"]);return(w.isValidElement(n)||(e=n,0!==w.Children.count(e)))&&(r=function(){return n}),l&&(h.computedMatch=l),b&&!I&&(b=!1),p(b)&&(b=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;return e<t?t:n<e?n:e}(b,1)),w.createElement(s.Route,h,function(l){var t,h=l.match,s=l.computedMatch,e=l.location,p=(H(l.match),e.pathname),f={when:a,className:c,behavior:i,cacheKey:m,unmount:u,saveScrollPosition:v};(l.history||{}).action,y&&y(p,l);return b?w.createElement(_.Fragment,null,Object.entries(d.cache).reduce(function(e,t){return e=e.concat((t[1]||[]).map(function(e){return[t[0],e]}))},[]).map(function(e){var t=C(e,2),n=t[0],r=t[1],o=r.render,c=r.updateTime,a=n===(y?y(p,l):p)?h||s:null,i=d.cache[n].slice();a&&e[1]!==i[0]&&(a=!1);var u=m+"__"+c;return w.createElement(_.Fragment,{key:u},o(P({},l,f,{cacheKey:m?{cacheKey:u,pathname:n,multiple:!0}:void 0,key:u,match:a})))})):(t=P({},l,f),w.createElement(B,t,function(e){return w.createElement(V,{when:H(t.match)},function(){return Object.assign(t,{cacheLifecycles:e}),o?w.createElement(o,t):g(r||n,void 0,t)})}))})}}]),c}(_.Component);X.componentName="CacheRoute",X.propTypes={component:t.elementType||t.any,render:t.func,children:t.oneOfType([t.func,t.node]),computedMatchForCacheRoute:t.object,multiple:t.oneOfType([t.bool,t.number])},X.defaultProps={multiple:!1};var z=function(){this.history=void 0,this.disposers=[],this.cache={},this.shouldCache=function(e,t,n){var r=!1;if(i(t))r=!t(n);else switch(t){case"always":break;case"back":["PUSH","REPLACE"].includes(e)&&(r=!0);break;case"forward":default:"POP"===e&&(r=!0)}return!r}};var G=n(_.Fragment)?function(e){var t=e.children;return w.createElement(_.Fragment,null,t)}:n(_.PropTypes)?function(e){var t=e.children;return w.createElement("div",null,t)}:function(e){return e.children};G.displayName="SwitchFragment";var J=n(s.__RouterContext),Q=function(e){function a(){var e,t,n;f(this,a);for(var r=arguments.length,o=Array(r),c=0;c<r;c++)o[c]=arguments[c];return(t=n=b(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(o)))).getContext=function(){if(J){var e=n.props;return{location:e.location,match:e.match}}var t=n.context.router.route;return{location:n.props.location||t.location,match:t.match}},b(n,t)}return v(a,e),d(a,[{key:"render",value:function(){var e=this.props,t=e.children,o=e.which,n=this.getContext(),c=n.location,a=n.match,i=!1;return w.createElement(V,{when:H(a)},function(){return w.createElement(G,null,w.Children.map(t,function(e){if(!w.isValidElement(e))return null;var t=e.props.path||e.props.from,n=i?null:t?s.matchPath(c.pathname,P({},e.props,{path:t}),a):a,r=void 0;return r=o(e)?w.cloneElement(e,P({location:c,computedMatch:n},u(n)?{computedMatchForCacheRoute:y({},F,!0)}:null)):n&&!i?w.cloneElement(e,{location:c,computedMatch:n}):null,i||(i=!!n),r}))})}}]),a}(s.Switch);J?(Q.propTypes={children:t.node,location:t.object.isRequired,match:t.object.isRequired,which:t.func},Q=s.withRouter(Q)):(Q.contextTypes={router:t.shape({route:t.object.isRequired}).isRequired},Q.propTypes={children:t.node,location:t.object,which:t.func}),Q.defaultProps={which:function(e){return h(e,"type")===X}};var Y=Q;e.default=X,e.CacheRoute=X,e.CacheSwitch=Y,e.dropByCacheKey=D,e.getCachingKeys=function(){return N().map(function(e){return C(e,1)[0]})},e.clearCache=function(){N().forEach(function(e){var t=C(e,1)[0];return D(t)})},e.getCachingComponents=function(){return N().reduce(function(e,t){var n=C(t,2),c=n[0],r=n[1];return P({},e,r instanceof B?y({},c,r):Object.entries(r).reduce(function(e,t){var n=C(t,2),r=n[0],o=n[1];return P({},e,y({},c+"."+r,o))},{}))},{})},Object.defineProperty(e,"__esModule",{value:!0})});
